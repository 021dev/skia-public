<!DOCTYPE html>
<html>
<head>
    <title>Skia+WebGPU compiled with Bazel</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="/build/hello-world.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background: #000;
        }
        p {
            color: white;
            font-family: sans-serif;
        }
    </style>
</head>
<body>
    <p id="log"></p>
    <canvas id="webgpu-demo-canvas" width=600 height=600></canvas>
    <script type="text/javascript" charset="utf-8">
      if (navigator.gpu) {
        log("WebGPU detected")
        WebGPUDemo();
      } else {
        log("No WebGPU support.")
      }

      function log(s) {
        document.getElementById("log").innerText = s;
      }

      async function WebGPUDemo() {
        const adapter = await navigator.gpu.requestAdapter();
        if (!adapter) {
          log("Could not load an adapter. For Chrome, try running with --enable-features=Vulkan --enable-unsafe-webgpu");
          return;
        }
        const device = await adapter.requestDevice();
        console.log(adapter, device);

        const wk = await WebGPUKitInit({locateFile: (file) => '/build/'+file});
        // https://github.com/emscripten-core/emscripten/issues/12750#issuecomment-725001907
        wk.preinitializedWebGPUDevice = device;

        timestamp = 0;
        flipColor = false;
        async function frame(now) {
          if (timestamp == 0 || now - timestamp >= 1000) {
              timestamp = now;
              const rv = await wk.drawWithSkia("#webgpu-demo-canvas", 600, 600, flipColor);
              flipColor = !flipColor;
              if (rv) {
                log('Skia drew frame with success');
              } else {
                log('Skia encountered an error');
              }
          }
          requestAnimationFrame(frame);
        }
        requestAnimationFrame(frame);
      }
    </script>
</body>
</html>
